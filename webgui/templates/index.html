{% extends "base.html" %}

{% block title %}New Download - HiAni DL{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-download"></i> New Download</h4>
            </div>
            <div class="card-body">
                {% if allowlist_enabled %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> <strong>URL Allowlist Active:</strong>
                    {% if allowlist %}
                        Only URLs from the following domains are allowed:
                        <code>{{ allowlist | join(', ') }}</code>
                    {% else %}
                        No domains are allowed. Please configure <code>URL_ALLOWLIST</code> environment variable.
                    {% endif %}
                </div>
                {% endif %}

                <form id="downloadForm">
                    <div class="mb-3">
                        <label for="url" class="form-label">Media URL <span class="text-danger">*</span></label>
                        <input
                            type="url"
                            class="form-control"
                            id="url"
                            name="url"
                            required
                            placeholder="https://example.com/video"
                            autocomplete="off"
                        >
                        <div class="form-text">
                            Enter the URL of the media you want to download
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="profile" class="form-label">Output Profile (Optional)</label>
                        <select class="form-select" id="profile" name="profile">
                            <option value="">Default</option>
                            <option value="sub">Subtitle</option>
                            <option value="dub">Dubbed</option>
                        </select>
                        <div class="form-text">
                            Select output profile if applicable
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="ep_from" class="form-label">Episode From (Optional)</label>
                            <input
                                type="number"
                                class="form-control"
                                id="ep_from"
                                name="ep_from"
                                min="1"
                                placeholder="1"
                                autocomplete="off"
                            >
                            <div class="form-text">
                                Starting episode number
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="ep_to" class="form-label">Episode To (Optional)</label>
                            <input
                                type="number"
                                class="form-control"
                                id="ep_to"
                                name="ep_to"
                                min="1"
                                placeholder="12"
                                autocomplete="off"
                            >
                            <div class="form-text">
                                Ending episode number
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="season" class="form-label">Season Number (Optional)</label>
                        <input
                            type="number"
                            class="form-control"
                            id="season"
                            name="season"
                            min="1"
                            placeholder="1"
                            autocomplete="off"
                        >
                        <div class="form-text">
                            Season number (defaults to 1 if not specified)
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="extra_args" class="form-label">
                            Extra Arguments (Optional)
                            <button
                                type="button"
                                class="btn btn-sm btn-link p-0 ms-1"
                                data-bs-toggle="modal"
                                data-bs-target="#argsInfoModal"
                                style="vertical-align: baseline;"
                                title="View available arguments"
                            >
                                <i class="bi bi-info-circle-fill text-primary"></i>
                            </button>
                        </label>
                        <input
                            type="text"
                            class="form-control"
                            id="extra_args"
                            name="extra_args"
                            placeholder="--no-subtitles --server HD-1"
                            autocomplete="off"
                        >
                        <div class="form-text">
                            Additional command-line arguments (advanced users only) - Click the <i class="bi bi-info-circle-fill text-primary"></i> icon for help
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-play-circle"></i> Start Download
                        </button>
                    </div>
                </form>

                <div id="submitResult" class="mt-3" style="display: none;"></div>
            </div>
        </div>

        <div class="card shadow mt-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-question-circle"></i> How to Use</h5>
            </div>
            <div class="card-body">
                <ol>
                    <li>Enter the URL of the media you want to download</li>
                    <li>Optionally select an output profile or add extra arguments</li>
                    <li>Click "Start Download" to queue the job</li>
                    <li>View progress on the <a href="/jobs">Jobs</a> page</li>
                </ol>
                <p class="mb-0 text-muted">
                    <small>
                        <i class="bi bi-info-circle"></i>
                        Downloads run in the background. You can close your browser and they will continue.
                    </small>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Arguments Info Modal -->
<div class="modal fade" id="argsInfoModal" tabindex="-1" aria-labelledby="argsInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="argsInfoModalLabel">
                    <i class="bi bi-info-circle-fill"></i> Available Optional Arguments
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-4">
                    <i class="bi bi-lightbulb"></i> <strong>Tip:</strong> Most options are set via the form fields above.<br>
                    Use Extra Arguments for advanced options like <code>--aria</code>, <code>--no-subtitles</code>, or <code>--server</code>.
                </p>

                <div class="accordion" id="argsAccordion">
                    <!-- Common Arguments -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#commonArgs">
                                <i class="bi bi-star-fill text-warning me-2"></i> <strong>Common Arguments</strong>
                            </button>
                        </h2>
                        <div id="commonArgs" class="accordion-collapse collapse show" data-bs-parent="#argsAccordion">
                            <div class="accordion-body">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th style="width: 35%;">Argument</th>
                                            <th>Description</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><code>--aria</code></td>
                                            <td><span class="badge bg-success">Enabled by Default</span> aria2c is already enabled for faster downloads. You don't need to add this flag.</td>
                                        </tr>
                                        <tr>
                                            <td><code>--no-subtitles</code></td>
                                            <td>Skip downloading subtitle files (.vtt)</td>
                                        </tr>
                                        <tr>
                                            <td><code>--server HD-1</code></td>
                                            <td>Specify streaming server (e.g., HD-1, HD-2, Vidstreaming)</td>
                                        </tr>
                                    </tbody>
                                </table>

                                <div class="alert alert-info mb-0" style="color: #000;">
                                    <strong>Example:</strong> <code>--no-subtitles</code>
                                    <br>
                                    <strong>Note:</strong> aria2c is already enabled by default for fast downloads
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Episode & Season Selection -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#episodeArgs">
                                <i class="bi bi-collection-play me-2"></i> <strong>Episode & Season Selection</strong>
                            </button>
                        </h2>
                        <div id="episodeArgs" class="accordion-collapse collapse" data-bs-parent="#argsAccordion">
                            <div class="accordion-body">
                                <div class="alert alert-warning" style="color: #000;">
                                    <i class="bi bi-exclamation-triangle"></i> <strong>Note:</strong> These are usually set via the form fields above.
                                    <br>
                                    Only use Extra Arguments if you need to override or combine options.
                                </div>

                                <table class="table table-sm">
                                    <tbody>
                                        <tr>
                                            <td style="width: 35%;"><code>--ep-from 1</code></td>
                                            <td>First episode number to download</td>
                                        </tr>
                                        <tr>
                                            <td><code>--ep-to 12</code></td>
                                            <td>Last episode number to download</td>
                                        </tr>
                                        <tr>
                                            <td><code>--season 2</code></td>
                                            <td>Season number to download</td>
                                        </tr>
                                        <tr>
                                            <td><code>--download-type sub</code></td>
                                            <td>Download type: <code>sub</code> or <code>dub</code></td>
                                        </tr>
                                    </tbody>
                                </table>

                                <div class="alert alert-info mb-0" style="color: #000;">
                                    <strong>Example:</strong> <code>--season 2 --ep-from 1 --ep-to 12</code>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Options -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#advancedArgs">
                                <i class="bi bi-gear-fill me-2"></i> <strong>Advanced Options</strong>
                            </button>
                        </h2>
                        <div id="advancedArgs" class="accordion-collapse collapse" data-bs-parent="#argsAccordion">
                            <div class="accordion-body">
                                <table class="table table-sm">
                                    <tbody>
                                        <tr>
                                            <td style="width: 35%;"><code>--filename "Name"</code></td>
                                            <td>Custom filename or anime name</td>
                                        </tr>
                                        <tr>
                                            <td><code>--output-dir /path</code></td>
                                            <td>Custom output directory (not recommended in Docker)</td>
                                        </tr>
                                    </tbody>
                                </table>

                                <div class="alert alert-warning mb-0" style="color: #000;">
                                    <i class="bi bi-exclamation-triangle"></i> <strong>Warning:</strong> Changing <code>--output-dir</code> in Docker can cause permission issues.
                                    Use volume mounts in <code>docker-compose.yml</code> instead.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Common Combinations -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#combinations">
                                <i class="bi bi-puzzle-fill me-2"></i> <strong>Common Combinations</strong>
                            </button>
                        </h2>
                        <div id="combinations" class="accordion-collapse collapse" data-bs-parent="#argsAccordion">
                            <div class="accordion-body">
                                <ul class="list-unstyled mb-0">
                                    <li class="mb-3">
                                        <strong><i class="bi bi-lightning-fill text-warning"></i> No subtitles:</strong><br>
                                        <code class="d-block mt-1 p-2 bg-light border rounded">--no-subtitles</code>
                                        <span class="d-block mt-1" style="color: #000;"><strong>Note:</strong> aria2c is already enabled by default for fast downloads</span>
                                    </li>
                                    <li class="mb-3">
                                        <strong><i class="bi bi-server text-primary"></i> Specific server:</strong><br>
                                        <code class="d-block mt-1 p-2 bg-light border rounded">--server HD-1</code>
                                    </li>
                                    <li class="mb-3">
                                        <strong><i class="bi bi-collection text-success"></i> Complete season with custom name:</strong><br>
                                        <code class="d-block mt-1 p-2 bg-light border rounded">--season 1 --ep-from 1 --ep-to 24 --filename "My Anime S01"</code>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a href="https://github.com/benjaminmue/Docker_Unraid_HianimeDownloader/blob/main/ARGS.md" target="_blank" class="btn btn-outline-primary me-auto">
                    <i class="bi bi-book"></i> Full Documentation
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('downloadForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const submitBtn = e.target.querySelector('button[type="submit"]');
    const resultDiv = document.getElementById('submitResult');

    // Disable button
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Starting...';

    // Get form data
    let extraArgs = document.getElementById('extra_args').value || '';
    const epFrom = document.getElementById('ep_from').value;
    const epTo = document.getElementById('ep_to').value;
    const season = document.getElementById('season').value;

    // Automatically add episode range and season to extra args
    if (epFrom) {
        extraArgs = `--ep-from ${epFrom} ${extraArgs}`.trim();
    }
    if (epTo) {
        extraArgs = `--ep-to ${epTo} ${extraArgs}`.trim();
    }
    if (season) {
        extraArgs = `--season ${season} ${extraArgs}`.trim();
    }

    const formData = {
        url: document.getElementById('url').value,
        profile: document.getElementById('profile').value || null,
        extra_args: extraArgs || null,
    };

    try {
        const response = await fetch('/api/jobs', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData),
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to create job');
        }

        const job = await response.json();

        // Show success message
        resultDiv.className = 'alert alert-success';
        resultDiv.innerHTML = `
            <i class="bi bi-check-circle"></i>
            <strong>Job Created!</strong>
            Job #${job.id} has been queued.
            <a href="/jobs/${job.id}" class="alert-link">View Details</a> or
            <a href="/jobs" class="alert-link">View All Jobs</a>
        `;
        resultDiv.style.display = 'block';

        // Reset form
        e.target.reset();

    } catch (error) {
        // Show error message
        resultDiv.className = 'alert alert-danger';
        resultDiv.innerHTML = `
            <i class="bi bi-exclamation-triangle"></i>
            <strong>Error:</strong> ${error.message}
        `;
        resultDiv.style.display = 'block';
    } finally {
        // Re-enable button
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-play-circle"></i> Start Download';
    }
});
</script>
{% endblock %}
